var maxThumbWidth=140,maxThumbHeight=140,stitchesPerInch=10,thumbColors={},contrastColors="#FFFAC8 #E6194B #3CB44B #FFE119 #0082C8 #F58231 #911EB4 #46F0F0 #F032E6 #D2F53C #FABEBE #008080 #800000 #808000 #000080".split(" "),currentTemplate={},colorLookup=[],palettes,currentChart={},pageOptions=[];function hexToRGB(b){b=parseInt(b,16);return[b>>16&255,b>>8&255,b&255]}function decToHex(b){b=Number(b).toString(16);2>b.length&&(b="0"+b);return b}
function rgbToHex(b,a,c){b=decToHex(b)+decToHex(a)+decToHex(c);return b=b.toUpperCase()}function makePix(b,a,c,e,f){return{type:"rect",x:b,y:a,w:c,h:e,color:f}}function makeLine(b,a,c,e,f,d){return{type:"line",x1:b,y1:a,x2:c,y2:e,lineWidth:f,lineColor:d}}function makeTickText(b,a,c,e){return{text:c,fontSize:e,relativePosition:{x:b,y:a}}}
function buildTable(){var b=[],a={style:"tableExample",table:{heights:18,widths:[85,40,40,130,70],body:b}};b.push([{text:"Canvas Color",style:"tableHeader",fontSize:14,bold:!0},{text:currentChart.colheaders[2],style:"tableHeader",fontSize:14,bold:!0},{text:currentChart.colheaders[3],style:"tableHeader",fontSize:14,bold:!0},{text:currentChart.colheaders[4],style:"tableHeader",fontSize:14,bold:!0},{text:"Wool Color",style:"tableHeader",fontSize:14,bold:!0}]);for(var c=0;c<currentChart.chartlines.length;c++){var e=
currentChart.chartlines[c];b.push([{text:"",fillColor:e[5],fontSize:12},{text:e[0],fontSize:12},{text:e[1],fontSize:12},{text:e[2],fontSize:12},{text:"",fillColor:e[4],fontSize:12}])}return a}
function buildChart(b,a,c,e,f,d){var m=[],l=[],q={stack:[{stack:l},{canvas:m}],margin:[0,32,0,0]},r=a.top,t=a.left,k=a.chartType,p;"wool"===k&&(p=0);"contrast"===k&&(p=1);if(!0===f){var g=colorLookup.length;k=f=36;var h=b.width*a.pixW,n=b.height*a.pixH,u=0;switch(d){case "T":f=(h-9*(g-1))/g;d=a.top;r=a.top+k+18;u=t;for(n=0;n<colorLookup.length;n++)h=n*(f+9)+u,g=d,h=makePix(h,g,f,k,colorLookup[n][p]),m.push(h);break;case "R":k=(n-9*(g-1))/g;d=r;u=h+18;for(n=0;n<colorLookup.length;n++)h=u,g=n*(k+9)+
d,h=makePix(h,g,f,k,colorLookup[n][p]),m.push(h);break;case "B":f=(h-9*(g-1))/g;d=n+18;r=a.top;u=t;for(n=0;n<colorLookup.length;n++)h=n*(f+9)+u,g=d,h=makePix(h,g,f,k,colorLookup[n][p]),m.push(h);break;case "L":for(k=(n-9*(g-1))/g,d=r,t=f+18,n=0;n<colorLookup.length;n++)h=u,g=n*(k+9)+d,h=makePix(h,g,f,k,colorLookup[n][p]),m.push(h)}}for(p=0;p<b.height;p++)for(f=0;f<b.width;f++)k=4*(f+p*b.width),k="#"+rgbToHex(b.data[k],b.data[k+1],b.data[k+2]),k=makePix(f*a.pixW+t,p*a.pixH+r,a.pixW,a.pixH,k),m.push(k);
if(!0===c){for(c=0;c<b.width;c++)f=p=c*a.pixW+t-a.lineOffset,k=r,u=b.height*a.pixH+r,0===c%a.tickDivSize&&(k-=a.tickLength,u+=a.tickLength,"major"===e&&(d=c*a.pixW+t-a.pixW,9>c&&(d+=a.pixW/2),g=r-2*a.pixH,h=b.height*a.pixH+r+a.pixH,g=makeTickText(d,g,c,a.fontSize),d=makeTickText(d,h,c,a.fontSize),l.push(g),l.push(d))),c===b.width-1&&(d=p+a.pixW,d=makeLine(d,k-a.tickLength,d,u+a.tickLength,a.lineWeight,a.lineColor),m.push(d),"major"===e&&(d=c*a.pixW+t,g=r-2*a.pixH,h=b.height*a.pixH+r+a.pixH,g=makeTickText(d,
g,c+1,a.fontSize),d=makeTickText(d,h,c+1,a.fontSize),l.push(g),l.push(d))),p=makeLine(p,k,f,u,a.lineWeight,a.lineColor),m.push(p),"all"===e&&(d=c*a.pixW+t,9>c&&(d+=a.pixW/4),g=r-a.pixH,h=b.height*a.pixH+r,g=makeTickText(d,g,c+1,a.fontSize),d=makeTickText(d,h,c+1,a.fontSize),l.push(g),l.push(d));for(c=0;c<b.height;c++)p=t,f=b.width*a.pixW+t,u=k=c*a.pixH+r-a.lineOffset,0===c%a.tickDivSize&&(p-=a.tickDivSize,f+=a.tickDivSize,"major"===e&&(d=c*a.pixH+r-a.pixH,g=t-a.pixW-a.pixW,h=b.width*a.pixW+t+a.pixW,
9>c&&(d+=a.pixH/4,g+=a.pixW/4,h+=a.pixW/4),g=makeTickText(g,d,c,a.fontSize),d=makeTickText(h,d,c,a.fontSize),l.push(g),l.push(d))),c===b.width-1&&(d=makeLine(p-a.pixH,k+a.tickLength,f+a.tickDivSize,u+a.tickLength,a.lineWeight,a.lineColor),m.push(d),"major"===e&&(d=c*a.pixH+r,g=t-a.pixW-a.pixW,h=b.width*a.pixW+t+a.pixW,9>c&&(d+=a.pixH/4,g+=a.pixW/4,h+=a.pixW/4),g=makeTickText(g,d,c+1,a.fontSize),d=makeTickText(h,d,c+1,a.fontSize),l.push(g),l.push(d))),p=makeLine(p,k,f,u,a.lineWeight,a.lineColor),m.push(p),
"all"===e&&(d=c*a.pixH+r,g=t-a.pixW-1,h=b.width*a.pixW+t+1,9>c&&(d+=a.pixH/4,g+=a.pixW/4,h+=a.pixW/4),g=makeTickText(g,d,c+1,a.fontSize),d=makeTickText(h,d,c+1,a.fontSize),l.push(g),l.push(d))}return q}
function getPageOptions(){for(var b=["page1print","page2print","page3print","page4print"],a=[],c=[],e=0;e<b.length;e++){var f=b[e];document.getElementById(f).checked&&a.push(f)}for(b=0;b<a.length;b++){f=a[b].split("print")[0];e={title:document.getElementById(f).innerText};for(var d=document.getElementsByName(f+"content"),m,l=0;l<d.length;l++)d[l].checked&&(m=d[l].value,e.content=m);e.showGrid=document.getElementById(f+"ShowGrid").checked;d=document.getElementsByName(f+"GridOptions");m="none";for(l=
0;l<d.length;l++)d[l].checked&&(m=d[l].value),e.ticks=m;e.showSwatch=document.getElementById(f+"ShowSwatch").checked;f=document.getElementsByName(f+"SwatchOptions");d="L";for(m=0;m<f.length;m++)f[m].checked&&(d=f[m].value),e.swatchPos=d;c.push(e)}return c}function updateTemplate(){for(var b=["marginLeft","marginTop","marginRight","marginBottom"],a=[],c=0;c<b.length;c++){var e=document.getElementById(b[c]).value;a.push(parseFloat(e))}currentTemplate.docDefinition.pageMargins=a}
function renderDocument(){var b=getPageOptions();updateTemplate();currentTemplate.pages=b;b=[];for(var a=0;a<currentTemplate.pages.length;a++){var c=currentTemplate.pages[a],e={top:0,left:0,pixW:7.2,pixH:7.2,lineWeight:.1,lineColor:"#000000",lineOffset:.05,tickLength:7.2,tickDivSize:10,fontSize:6,chartType:""},f=c.showSwatch,d=c.swatchPos,m=c.showGrid,l=c.ticks;var q={text:"Page "+(a+1)+" "+c.title,margin:[0,64,0,32]};b.push(q);switch(c.content){case "contrast":e.chartType="contrast";q=document.getElementById("contrastthumbcanvas");
q=q.getContext("2d");q=q.getImageData(0,0,q.canvas.width,q.canvas.height);e=buildChart(q,e,m,l,f,d);b.push(e);break;case "wool":e.chartType="wool";q=document.getElementById("originalthumbcanvas");q=q.getContext("2d");q=q.getImageData(0,0,q.canvas.width,q.canvas.height);e=buildChart(q,e,m,l,f,d);b.push(e);break;case "chart":e.chartType="chart",e=buildTable(),b.push(e)}q=a!==currentTemplate.pages.length-1?[{text:" ",margin:[0,64,0,0],pageBreak:"after"}]:[{text:" ",margin:[0,64,0,0]}];b.push(q)}currentTemplate.docDefinition.content=
b;currentTemplate.docDefinition.info={title:"Stitchme Automation Prototype",author:"Andrew Craigie",subject:"Stitchme Print Pages"};pdfMake.createPdf(currentTemplate.docDefinition).getDataUrl(function(a){document.getElementById("pdfFrame").src=a})}function setContrastCanvasSize(){var b=document.getElementById("originalthumbcanvas"),a=document.getElementById("contrastthumbcanvas");a.width=b.width;a.height=b.height;setContainerDimensions(a.parentNode,a.width,a.height)}
function renderContrastThumb(b){var a=document.getElementById("originalthumbcanvas"),c=document.getElementById("contrastthumbcanvas");a=a.getContext("2d").getImageData(0,0,a.width,a.height);setContrastCanvasSize();var e=c.getContext("2d");e.clearRect(0,0,c.width,c.height);for(c=0;c<a.data.length;c+=4){var f="#"+rgbToHex(a.data[c],a.data[c+1],a.data[c+2]);f=b.colorLookup[f].split("#")[1];f=hexToRGB(f);a.data[c]=f[0];a.data[c+1]=f[1];a.data[c+2]=f[2]}e.putImageData(a,0,0)}
function chartToTable(b){var a=document.createElement("tbody"),c=document.createElement("tr"),e=document.createElement("th");e.align="left";e.colSpan="6";e.innerText=b.woolpalette;c.appendChild(e);e=document.createElement("th");e.align="right";e.colSpan="1";e.innerText=b.contrastpalette;c.appendChild(e);a.appendChild(c);c=document.createElement("tr");for(e=0;e<b.colheaders.length;e++){var f=document.createElement("td");f.innerText=b.colheaders[e];c.appendChild(f)}a.appendChild(c);b=b.chartlines;for(c=
0;c<b.length;c++){e=b[c];f=document.createElement("tr");var d=document.createElement("td");d.innerText=c+1;f.appendChild(d);d=document.createElement("td");d.bgColor=e[4];f.appendChild(d);d=document.createElement("td");d.innerText=e[0];f.appendChild(d);d=document.createElement("td");d.innerText=e[1];f.appendChild(d);d=document.createElement("td");d.innerText=e[2];f.appendChild(d);d=document.createElement("td");d.innerText=e[3];f.appendChild(d);d=document.createElement("td");d.bgColor=e[5];f.appendChild(d);
a.appendChild(f)}b=document.getElementById("charttable");b.innerHTML="";b.appendChild(a)}
function createChartObj(b,a){var c={woolpalette:palettes.ANW.palettename,contrastpalette:"Contrast 1",colheaders:"No Swatch Prefix Code Name Stitches Swatch".split(" "),chartlines:[],colorLookup:{}};colorLookup=[];for(var e=0;e<b.colors.length;e++){var f="#"+b.colors[e];f=f.toUpperCase();var d=palettes.ANW.threads[f];void 0!==d?(d=[d[0],d[1],d[2],b.colorTotals[b.colors[e]],f,a[e]],colorLookup.push([f,a[e]]),c.chartlines.push(d),c.colorLookup[f]=a[e]):(d="--- ---- ---- 0 #FFFFFF #FFFFFF".split(" "),
c.chartlines.push(d))}return c}function createColorList(b){result={colorCount:0,colors:[],colorTotals:{}};for(var a=0;a<b.length;++a)result.colorTotals[b[a]]||(result.colorTotals[b[a]]=0,result.colorCount++,result.colors.push(b[a])),++result.colorTotals[b[a]];return result}function getColors(b){var a=[];b=b.getContext("2d").getImageData(0,0,b.width,b.height);for(var c=0;c<b.data.length;c+=4){var e=rgbToHex(b.data[c],b.data[c+1],b.data[c+2]);a.push(e)}return a}
function showThumbDimensions(b,a){document.getElementById("thumbdimensions").innerText=b+"px x "+a+"px @ "+stitchesPerInch+" stitches/in = "+b/stitchesPerInch+"in x "+a/stitchesPerInch+"in"}function setContainerDimensions(b,a,c){b.setAttribute("style","width:"+a+"px;"+("height:"+c+"px;"))}
function renderWoolThumb(b,a){var c=b.getContext("2d");c.clearRect(0,0,b.width,b.height);var e=new Image;e.onload=function(){if(this.width>maxThumbWidth||this.height>maxThumbHeight)alert("Thumbnail image loaded is larger than 140 x 140 px");else{b.width=this.width;b.height=this.height;c.drawImage(this,0,0,this.width,this.height);setContainerDimensions(b.parentNode,this.width,this.height);showThumbDimensions(this.width,this.height);var a=getColors(b);thumbColors=createColorList(a);currentChart=a=createChartObj(thumbColors,
contrastColors);chartToTable(a);15>=thumbColors.colors.length?renderContrastThumb(a):(setContrastCanvasSize(),alert("The thumbnail image contains more than 15 wool colours"))}};e.src=a}function loadThumbnail(){var b=document.getElementById("thumbnailload").files,a=document.getElementById("originalthumbcanvas");if(0<b.length){b=b[0];var c=new FileReader;c.onload=function(b){renderWoolThumb(a,b.target.result)};c.readAsDataURL(b)}}
window.onload=function(){thumbColors={};currentTemplate=templates.A4Portrait;var b=new XMLHttpRequest("json/palette_json.json.js");b.open("GET","json/palette_json.json.js");b.responseType="json";b.send();b.onload=function(){var a=b.response;try{palettes=JSON.parse(a)}catch(c){palettes=a}console.dir(a)}};